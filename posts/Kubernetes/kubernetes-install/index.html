<!doctype html>
<html lang="zh">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Kubernetes安装步骤 | Linuxkai 的博客</title>
    <meta property="og:title" content="Kubernetes安装步骤 - Linuxkai 的博客">
    <meta property="og:type" content="article">
    
    <meta property="article:published_time" content='2021-12-01T13:15:28&#43;08:00'>
    
    
    <meta property="article:modified_time" content='2021-12-01T13:15:28&#43;08:00'>
    
    <meta name="Keywords" content="运维笔记,Python开发,,Go语言,公众号,小程序">
    <meta name="description" content="Kubernetes安装步骤">
    
    <meta name="author" content="">
    <meta property="og:url" content="https://blog.linuxkai.com/posts/Kubernetes/kubernetes-install/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    

    
    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?b288dcb7926623147c327f43aa44d284";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    

    

    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://blog.linuxkai.com/">
                        Linuxkai 的博客
                    </a>
                
                <p class="description">运维笔记,Python开发,Golang语言</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://blog.linuxkai.com/">首页</a>
                    
                    <a  href="https://blog.linuxkai.com/archives/" title="归档">归档</a>
                    
                    <a  href="https://blog.linuxkai.com/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 5px;
         
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#前置知识点">前置知识点</a>
      <ul>
        <li><a href="#生产环境部署k8s-集群有两种模式">生产环境部署k8s 集群有两种模式</a></li>
        <li><a href="#k8s-各种组件">k8s 各种组件</a></li>
      </ul>
    </li>
    <li><a href="#环境">环境</a>
      <ul>
        <li><a href="#安装要求">安装要求</a></li>
        <li><a href="#机器aliyun">机器(aliyun)</a></li>
      </ul>
    </li>
    <li><a href="#环境准备">环境准备</a>
      <ul>
        <li><a href="#关闭防火墙">关闭防火墙</a></li>
        <li><a href="#关闭selinux">关闭selinux</a></li>
        <li><a href="#关闭swap">关闭swap</a></li>
        <li><a href="#修改主机名">修改主机名</a></li>
        <li><a href="#在master添加hosts">在master添加hosts</a></li>
        <li><a href="#将桥接的ipv4流量传递到iptables的链并调整内核参数">将桥接的IPv4流量传递到iptables的链,并调整内核参数</a></li>
        <li><a href="#时间同步">时间同步</a></li>
        <li><a href="#更新内核">更新内核</a></li>
      </ul>
    </li>
    <li><a href="#部署-etcd-集群">部署 Etcd 集群</a>
      <ul>
        <li><a href="#etcd节点分配">Etcd节点分配</a></li>
        <li><a href="#准备cfssl证书生成工具">准备cfssl证书生成工具</a></li>
        <li><a href="#生成etcd证书">生成Etcd证书</a>
          <ul>
            <li><a href="#创建工作目录">创建工作目录</a></li>
            <li><a href="#自签ca">自签CA</a></li>
            <li><a href="#生成证书">生成证书</a></li>
          </ul>
        </li>
        <li><a href="#使用自签ca签发etcd-https证书">使用自签CA签发Etcd HTTPS证书</a>
          <ul>
            <li><a href="#创建证书申请文件">创建证书申请文件</a></li>
          </ul>
        </li>
        <li><a href="#生成证书-1">生成证书</a></li>
        <li><a href="#从github下载二进制文件">从Github下载二进制文件</a></li>
        <li><a href="#部署etcd集群">部署Etcd集群</a>
          <ul>
            <li><a href="#创建工作目录并解压二进制包">创建工作目录并解压二进制包</a></li>
            <li><a href="#创建etcd配置文件">创建etcd配置文件</a></li>
            <li><a href="#systemd管理etcd">systemd管理etcd</a></li>
            <li><a href="#拷贝刚才生成的证书">拷贝刚才生成的证书</a></li>
            <li><a href="#启动并设置开机启动">启动并设置开机启动</a></li>
            <li><a href="#将上面节点1所有生成的文件拷贝到节点2和节点3">将上面节点1所有生成的文件拷贝到节点2和节点3</a></li>
            <li><a href="#然后在节点2和节点3分别修改etcdconf配置文件中的节点名称和当前服务器ip">然后在节点2和节点3分别修改etcd.conf配置文件中的节点名称和当前服务器IP</a></li>
            <li><a href="#查看集群状态如果和下面显示一样说明集群部署成功">查看集群状态,如果和下面显示一样，说明集群部署成功</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#安装-docker">安装 docker</a>
      <ul>
        <li><a href="#yum-安装-docker和下面的二进制安装-docker--二选一即可">yum 安装 docker（和下面的二进制安装 docker  二选一即可）</a></li>
        <li><a href="#二进制安装-docker">二进制安装 docker</a>
          <ul>
            <li><a href="#下载二进制-docker-包-然后解压">下载二进制 docker 包, 然后解压</a></li>
            <li><a href="#systemd管理docker">systemd管理docker</a></li>
            <li><a href="#创建配置文件">创建配置文件</a></li>
            <li><a href="#启动docker并设置开机启动">启动docker并设置开机启动</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#部署master-node">部署Master Node</a>
      <ul>
        <li><a href="#生成kube-apiserver证书">生成kube-apiserver证书</a>
          <ul>
            <li><a href="#进入到相应工作目录">进入到相应工作目录</a></li>
            <li><a href="#自签证书颁发机构ca">自签证书颁发机构（CA）</a></li>
            <li><a href="#生成证书-2">生成证书</a></li>
            <li><a href="#使用自签ca签发kube-apiserver-https证书">使用自签CA签发kube-apiserver HTTPS证书</a></li>
          </ul>
        </li>
        <li><a href="#下载二进制包">下载二进制包</a></li>
        <li><a href="#解压二进制包">解压二进制包</a></li>
        <li><a href="#部署kube-apiserver">部署kube-apiserver</a>
          <ul>
            <li><a href="#创建配置文件-1">创建配置文件</a></li>
            <li><a href="#启用-tls-bootstrapping-机制">启用 TLS Bootstrapping 机制</a></li>
            <li><a href="#systemd管理apiserver">systemd管理apiserver</a></li>
            <li><a href="#启动并设置开机启动-1">启动并设置开机启动</a></li>
            <li><a href="#授权kubelet-bootstrap用户允许请求证书">授权kubelet-bootstrap用户允许请求证书</a></li>
          </ul>
        </li>
        <li><a href="#部署kube-controller-manager">部署kube-controller-manager</a>
          <ul>
            <li><a href="#创建配置文件-2">创建配置文件</a></li>
            <li><a href="#systemd管理controller-manager">systemd管理controller-manager</a></li>
            <li><a href="#启动并设置开机启动-2">启动并设置开机启动</a></li>
          </ul>
        </li>
        <li><a href="#部署kube-scheduler">部署kube-scheduler</a>
          <ul>
            <li><a href="#创建配置文件-3">创建配置文件</a></li>
            <li><a href="#systemd管理scheduler">systemd管理scheduler</a></li>
            <li><a href="#启动并设置开机启动-3">启动并设置开机启动</a></li>
            <li><a href="#查看集群状态">查看集群状态</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#部署worker-node">部署Worker Node</a>
      <ul>
        <li><a href="#创建工作目录并拷贝二进制文件">创建工作目录并拷贝二进制文件</a>
          <ul>
            <li><a href="#在所有worker-node创建工作目录">在所有worker node创建工作目录</a></li>
            <li><a href="#从master节点拷贝">从master节点拷贝</a></li>
          </ul>
        </li>
        <li><a href="#部署kubelet">部署kubelet</a>
          <ul>
            <li><a href="#创建配置文件-4">创建配置文件</a></li>
            <li><a href="#配置参数文件">配置参数文件</a></li>
            <li><a href="#生成bootstrapkubeconfig文件">生成bootstrap.kubeconfig文件</a></li>
            <li><a href="#systemd管理kubelet">systemd管理kubelet</a></li>
            <li><a href="#启动并设置开机启动-4">启动并设置开机启动</a></li>
          </ul>
        </li>
        <li><a href="#批准kubelet证书申请并加入集群">批准kubelet证书申请并加入集群</a></li>
        <li><a href="#部署kube-proxy">部署kube-proxy</a>
          <ul>
            <li><a href="#创建配置文件-5">创建配置文件</a></li>
            <li><a href="#配置参数文件-1">配置参数文件</a></li>
            <li><a href="#生成kube-proxykubeconfig文件">生成kube-proxy.kubeconfig文件</a></li>
            <li><a href="#systemd管理kube-proxy">systemd管理kube-proxy</a></li>
          </ul>
        </li>
        <li><a href="#部署cni网络">部署CNI网络</a>
          <ul>
            <li><a href="#先准备好-cni二进制包">先准备好 CNI二进制包</a></li>
            <li><a href="#解压二进制包并移动到默认工作目录">解压二进制包并移动到默认工作目录</a></li>
            <li><a href="#部署cni网络-1">部署CNI网络</a></li>
          </ul>
        </li>
        <li><a href="#授权apiserver访问kubelet">授权apiserver访问kubelet</a></li>
        <li><a href="#新增加worker-node">新增加Worker Node</a>
          <ul>
            <li><a href="#拷贝已部署好的node相关文件到新节点">拷贝已部署好的Node相关文件到新节点</a></li>
            <li><a href="#删除kubelet证书和kubeconfig文件">删除kubelet证书和kubeconfig文件</a></li>
            <li><a href="#修改主机名-1">修改主机名</a></li>
            <li><a href="#启动并设置开机启动-5">启动并设置开机启动</a></li>
            <li><a href="#在master上批准新node-kubelet证书申请">在Master上批准新Node kubelet证书申请</a></li>
            <li><a href="#查看node状态">查看Node状态</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#部署dashboard和coredns">部署Dashboard和CoreDNS</a>
      <ul>
        <li><a href="#部署dashboard">部署Dashboard</a>
          <ul>
            <li><a href="#下载-yaml-文件">下载 yaml 文件</a></li>
            <li><a href="#默认dashboard只能集群内部访问修改service为nodeport类型暴露到外部">默认Dashboard只能集群内部访问，修改Service为NodePort类型，暴露到外部</a></li>
            <li><a href="#部署-dashboard">部署 dashboard</a></li>
            <li><a href="#查看dashboard信息">查看dashboard信息</a></li>
            <li><a href="#创建service-account并绑定默认cluster-admin管理员集群角色">创建service account并绑定默认cluster-admin管理员集群角色</a></li>
          </ul>
        </li>
        <li><a href="#部署coredns">部署CoreDNS</a>
          <ul>
            <li><a href="#准备-corednsyaml">准备 coredns.yaml</a></li>
            <li><a href="#部署-coredns">部署 coredns</a></li>
            <li><a href="#dns解析测试">DNS解析测试</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if (leftPos < 220) {
                postToc.css({ "width": leftPos - 10, "margin-left": (0 - leftPos) })
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }

        if ($("#TableOfContents").children().length < 1) {
            $(".post-toc").remove();
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">Kubernetes安装步骤</h1>
        </header>
        
  <time datetime="2021-12-01T05:15:28Z" class="post-meta meta-date dt-published">
    发布日期: 2021年12月1日
  </time>


  <time datetime="2021-12-01T05:15:28Z" class="post-meta meta-updated">
    | 更新日期: 2021年12月1日
  </time>


<div class="post-meta meta-category">
  <span>&nbsp;| 文章分类: </span>
  
    <a href='/categories/Kubernetes' target="_blank">Kubernetes</a>
  
</div>


        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">&nbsp;|
                <span id="busuanzi_value_page_pv"></span> <span>阅读</span>
            </span>
        </div>
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">文章目录</div>
            </div>
        </div>
        
        <div class="post-content">
            <h1 id="kubernetes-install">kubernetes install</h1>
<h2 id="前置知识点">前置知识点</h2>
<h3 id="生产环境部署k8s-集群有两种模式">生产环境部署k8s 集群有两种模式</h3>
<ul>
<li>kubeadm: Kubeadm是一个K8s部署工具，提供kubeadm init和kubeadm join，用于快速部署Kubernetes集群</li>
<li>二进制包: 从github下载发行版的二进制包，手动部署每个组件，组成Kubernetes集群。Kubeadm降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可控，推荐使用二进制包部署Kubernetes集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护</li>
</ul>
<h3 id="k8s-各种组件">k8s 各种组件</h3>
<hr>
<h2 id="环境">环境</h2>
<h3 id="安装要求">安装要求</h3>
<hr>
<h3 id="机器aliyun">机器(aliyun)</h3>
<ul>
<li>172.26.3.200(centos 7.8 2c4g)  k8s-master    11</li>
<li>172.26.3.201(centos 7.8 2c4g)  k8s-node1      227</li>
<li>172.26.3.202(centos 7.8 2c4g)  k8s-node2      185</li>
</ul>
<h2 id="环境准备">环境准备</h2>
<h3 id="关闭防火墙">关闭防火墙</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl stop firewalld
</span></span><span style="display:flex;"><span>systemctl disable firewalld
</span></span></code></pre></div><h3 id="关闭selinux">关闭selinux</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sed -i <span style="color:#a6e3a1">&#39;s/enforcing/disabled/&#39;</span> /etc/selinux/config  <span style="color:#6c7086;font-style:italic"># 永久</span>
</span></span><span style="display:flex;"><span>setenforce <span style="color:#fab387">0</span>  <span style="color:#6c7086;font-style:italic"># 临时</span>
</span></span></code></pre></div><h3 id="关闭swap">关闭swap</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>swapoff -a  <span style="color:#6c7086;font-style:italic"># 临时</span>
</span></span><span style="display:flex;"><span>sed -ri <span style="color:#a6e3a1">&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab    <span style="color:#6c7086;font-style:italic"># 永久</span>
</span></span></code></pre></div><h3 id="修改主机名">修改主机名</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>hostnamectl set-hostname k8s-master
</span></span><span style="display:flex;"><span>hostnamectl set-hostname k8s-node1
</span></span><span style="display:flex;"><span>hostnamectl set-hostname k8s-node2
</span></span></code></pre></div><h3 id="在master添加hosts">在master添加hosts</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt;&gt; /etc/hosts <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">172.26.3.200 k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">172.26.3.201 k8s-node01
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">172.26.3.200 k8s-node02
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h3 id="将桥接的ipv4流量传递到iptables的链并调整内核参数">将桥接的IPv4流量传递到iptables的链,并调整内核参数</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/sysctl.d/k8s.conf <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">net.ipv4.ip_forward=1
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">net.ipv4.tcp_tw_recycle=0
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">vm.swappiness=0
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">vm.overcommit_memory=1
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">vm.panic_on_oom=0
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">fs.inotify.max_user_instances=8192
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">fs.inotify.max_user_watches=1048576
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">fs.file-max=52706963
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">fs.nr_open=52706963
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">net.ipv6.conf.all.disable_ipv6=1
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">net.netfilter.nf_conntrack_max=2310720
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span><span style="display:flex;"><span>sysctl --system  <span style="color:#6c7086;font-style:italic"># 生效</span>
</span></span></code></pre></div><h3 id="时间同步">时间同步</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>yum install ntpdate -y
</span></span><span style="display:flex;"><span>ntpdate ntp.aliyun.com
</span></span></code></pre></div><h3 id="更新内核">更新内核</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
</span></span><span style="display:flex;"><span>rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm
</span></span><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic">#安装内核</span>
</span></span><span style="display:flex;"><span>yum --enablerepo<span style="color:#89dceb;font-weight:bold">=</span>elrepo-kernel install -y kernel-lt
</span></span><span style="display:flex;"><span>查看当前的所有内核版本
</span></span><span style="display:flex;"><span>cat /boot/grub2/grub.cfg | grep menuentry
</span></span><span style="display:flex;"><span>查看当前启动内核版本
</span></span><span style="display:flex;"><span>grub2-editenv list
</span></span><span style="display:flex;"><span>修改启动内核版本，设置开机从新内核启动
</span></span><span style="display:flex;"><span>grub2-set-default <span style="color:#a6e3a1">&#39;CentOS Linux (5.4.108-1.el7.elrepo.x86_64) 7 (Core)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic">#注意：设置完内核后，需要重启服务器才会生效。</span>
</span></span><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic">#查询内核</span>
</span></span><span style="display:flex;"><span>uname -r
</span></span></code></pre></div><h2 id="部署-etcd-集群">部署 Etcd 集群</h2>
<h3 id="etcd节点分配">Etcd节点分配</h3>
<ul>
<li>172.26.3.200  etcd1</li>
<li>172.26.3.201  etcd2</li>
<li>172.26.3.202  etcd3</li>
</ul>
<h3 id="准备cfssl证书生成工具">准备cfssl证书生成工具</h3>
<p>cfssl是一个开源的证书管理工具，使用json文件生成证书，相比openssl更方便使用。
找任意一台服务器操作，这里用Master节点</p>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
</span></span><span style="display:flex;"><span>wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
</span></span><span style="display:flex;"><span>wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
</span></span><span style="display:flex;"><span>chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64
</span></span><span style="display:flex;"><span>mv cfssl_linux-amd64 /usr/local/bin/cfssl
</span></span><span style="display:flex;"><span>mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
</span></span><span style="display:flex;"><span>mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</span></span></code></pre></div><h3 id="生成etcd证书">生成Etcd证书</h3>
<h4 id="创建工作目录">创建工作目录</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p ~/TLS/<span style="color:#89dceb;font-weight:bold">{</span>etcd,k8s<span style="color:#89dceb;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#89dceb">cd</span> TLS/etcd
</span></span></code></pre></div><h4 id="自签ca">自签CA</h4>
<ul>
<li>ca-config.json</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; ca-config.json <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">{
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  &#34;signing&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;default&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;expiry&#34;: &#34;87600h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    },
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;profiles&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;www&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">         &#34;expiry&#34;: &#34;87600h&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">         &#34;usages&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;signing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;key encipherment&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;server auth&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;client auth&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">}
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><ul>
<li>ca-csr.json</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; ca-csr.json <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">{
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;CN&#34;: &#34;etcd CA&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    },
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;ST&#34;: &#34;Beijing&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">}
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="生成证书">生成证书</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
</span></span><span style="display:flex;"><span>ls *pem
</span></span><span style="display:flex;"><span>ca-key.pem  ca.pem
</span></span></code></pre></div><h3 id="使用自签ca签发etcd-https证书">使用自签CA签发Etcd HTTPS证书</h3>
<h4 id="创建证书申请文件">创建证书申请文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; server-csr.json <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">{
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;CN&#34;: &#34;etcd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;172.26.3.200&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;172.26.3.201&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;172.26.3.202&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    },
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;ST&#34;: &#34;BeiJing&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">}
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><p><!-- raw HTML omitted -->注：上述文件hosts字段中IP为所有etcd节点的集群内部通信IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP<!-- raw HTML omitted --></p>
<h3 id="生成证书-1">生成证书</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#89dceb;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#89dceb;font-weight:bold">=</span>ca-key.pem -config<span style="color:#89dceb;font-weight:bold">=</span>ca-config.json -profile<span style="color:#89dceb;font-weight:bold">=</span>www server-csr.json | cfssljson -bare server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ls server*pem
</span></span><span style="display:flex;"><span>server-key.pem  server.pem
</span></span></code></pre></div><h3 id="从github下载二进制文件">从Github下载二进制文件</h3>
<p>下载地址：
<a href="https://github.com/etcd-io/etcd/releases/download/v3.4.15/etcd-v3.4.15-linux-amd64.tar.gz">https://github.com/etcd-io/etcd/releases/download/v3.4.15/etcd-v3.4.15-linux-amd64.tar.gz</a></p>
<h3 id="部署etcd集群">部署Etcd集群</h3>
<p>以下在节点1上操作，为简化操作，待会将节点1生成的所有文件拷贝到节点2和节点3</p>
<h4 id="创建工作目录并解压二进制包">创建工作目录并解压二进制包</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir /opt/etcd/<span style="color:#89dceb;font-weight:bold">{</span>bin,cfg,ssl<span style="color:#89dceb;font-weight:bold">}</span> -p
</span></span><span style="display:flex;"><span>tar zxvf etcd-v3.4.15-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>mv etcd-v3.4.15-linux-amd64/<span style="color:#89dceb;font-weight:bold">{</span>etcd,etcdctl<span style="color:#89dceb;font-weight:bold">}</span> /opt/etcd/bin/
</span></span></code></pre></div><h4 id="创建etcd配置文件">创建etcd配置文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /opt/etcd/cfg/etcd.conf <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">#[Member]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ETCD_NAME=&#34;etcd-1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ETCD_LISTEN_PEER_URLS=&#34;https://172.26.3.200:2380&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ETCD_LISTEN_CLIENT_URLS=&#34;https://172.26.3.200:2379&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">#[Clustering]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;https://172.26.3.200:2380&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ETCD_ADVERTISE_CLIENT_URLS=&#34;https://172.26.3.200:2379&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ETCD_INITIAL_CLUSTER=&#34;etcd-1=https://172.26.3.200:2380,etcd-2=https://172.26.3.201:2380,etcd-3=https://172.26.3.202:2380&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-cluster&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><p>说明：</p>
<ul>
<li>ETCD_NAME：节点名称，集群中唯一</li>
<li>ETCD_DATA_DIR：数据目录</li>
<li>ETCD_LISTEN_PEER_URLS：集群通信监听地址</li>
<li>ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址</li>
<li>ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址</li>
<li>ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址</li>
<li>ETCD_INITIAL_CLUSTER：集群节点地址</li>
<li>ETCD_INITIAL_CLUSTER_TOKEN：集群Token</li>
<li>ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群</li>
</ul>
<h4 id="systemd管理etcd">systemd管理etcd</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /usr/lib/systemd/system/etcd.service <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Description=Etcd Server
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EnvironmentFile=/opt/etcd/cfg/etcd.conf
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ExecStart=/opt/etcd/bin/etcd \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--cert-file=/opt/etcd/ssl/server.pem \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--key-file=/opt/etcd/ssl/server-key.pem \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--peer-cert-file=/opt/etcd/ssl/server.pem \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--peer-key-file=/opt/etcd/ssl/server-key.pem \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--trusted-ca-file=/opt/etcd/ssl/ca.pem \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--logger=zap
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="拷贝刚才生成的证书">拷贝刚才生成的证书</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cp ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/
</span></span></code></pre></div><h4 id="启动并设置开机启动">启动并设置开机启动</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl start etcd
</span></span><span style="display:flex;"><span>systemctl <span style="color:#89dceb">enable</span> etcd
</span></span></code></pre></div><h4 id="将上面节点1所有生成的文件拷贝到节点2和节点3">将上面节点1所有生成的文件拷贝到节点2和节点3</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>scp -r /opt/etcd/ root@172.26.3.201:/opt/
</span></span><span style="display:flex;"><span>scp /usr/lib/systemd/system/etcd.service root@172.26.3.201:/usr/lib/systemd/system/
</span></span><span style="display:flex;"><span>scp -r /opt/etcd/ root@172.26.3.202:/opt/
</span></span><span style="display:flex;"><span>scp /usr/lib/systemd/system/etcd.service root@172.26.3.202:/usr/lib/systemd/system/
</span></span></code></pre></div><h4 id="然后在节点2和节点3分别修改etcdconf配置文件中的节点名称和当前服务器ip">然后在节点2和节点3分别修改etcd.conf配置文件中的节点名称和当前服务器IP</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vi /opt/etcd/cfg/etcd.conf
</span></span><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic">#[Member]</span>
</span></span><span style="display:flex;"><span><span style="color:#f5e0dc">ETCD_NAME</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;etcd-1&#34;</span>   <span style="color:#6c7086;font-style:italic"># 修改此处，节点2改为etcd-2，节点3改为etcd-3</span>
</span></span><span style="display:flex;"><span><span style="color:#f5e0dc">ETCD_DATA_DIR</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;/var/lib/etcd/default.etcd&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f5e0dc">ETCD_LISTEN_PEER_URLS</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;https://172.26.3.200:2380&#34;</span>   <span style="color:#6c7086;font-style:italic"># 修改此处为当前服务器IP</span>
</span></span><span style="display:flex;"><span><span style="color:#f5e0dc">ETCD_LISTEN_CLIENT_URLS</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;https://172.26.3.200:2379&#34;</span> <span style="color:#6c7086;font-style:italic"># 修改此处为当前服务器IP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic">#[Clustering]</span>
</span></span><span style="display:flex;"><span><span style="color:#f5e0dc">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;https://172.26.3.200:2380&#34;</span> <span style="color:#6c7086;font-style:italic"># 修改此处为当前服务器IP</span>
</span></span><span style="display:flex;"><span><span style="color:#f5e0dc">ETCD_ADVERTISE_CLIENT_URLS</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;https://172.26.3.200:2379&#34;</span> <span style="color:#6c7086;font-style:italic"># 修改此处为当前服务器IP</span>
</span></span><span style="display:flex;"><span><span style="color:#f5e0dc">ETCD_INITIAL_CLUSTER</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;etcd-1=https://172.26.3.200:2380,etcd-2=https://172.26.3.201:2380,etcd-3=https://172.26.3.202:2380&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f5e0dc">ETCD_INITIAL_CLUSTER_TOKEN</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;etcd-cluster&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f5e0dc">ETCD_INITIAL_CLUSTER_STATE</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;new&#34;</span>
</span></span></code></pre></div><p>注：节点2，节点3按照上面操作修改完配置文件后，请执行上面第5步,启动Etcd并设置开机启动</p>
<h4 id="查看集群状态如果和下面显示一样说明集群部署成功">查看集群状态,如果和下面显示一样，说明集群部署成功</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#89dceb;font-weight:bold">[</span>root@k8s-master ~<span style="color:#89dceb;font-weight:bold">]</span><span style="color:#6c7086;font-style:italic"># /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&#34;https://172.26.3.200:2379,https://172.26.3.201:2379,https://172.26.3.202:2379&#34; endpoint health</span>
</span></span><span style="display:flex;"><span>https://172.26.3.200:2379 is healthy: successfully committed proposal: <span style="color:#f5e0dc">took</span> <span style="color:#89dceb;font-weight:bold">=</span> 9.304973ms
</span></span><span style="display:flex;"><span>https://172.26.3.202:2379 is healthy: successfully committed proposal: <span style="color:#f5e0dc">took</span> <span style="color:#89dceb;font-weight:bold">=</span> 10.072233ms
</span></span><span style="display:flex;"><span>https://172.26.3.201:2379 is healthy: successfully committed proposal: <span style="color:#f5e0dc">took</span> <span style="color:#89dceb;font-weight:bold">=</span> 13.895536ms
</span></span></code></pre></div><h2 id="安装-docker">安装 docker</h2>
<p><!-- raw HTML omitted -->以下操作在所有节点操作<!-- raw HTML omitted --></p>
<h3 id="yum-安装-docker和下面的二进制安装-docker--二选一即可">yum 安装 docker（和下面的二进制安装 docker  二选一即可）</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine
</span></span><span style="display:flex;"><span>sudo yum install -y yum-utils
</span></span><span style="display:flex;"><span>sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>sudo yum-config-manager --enable docker-ce-nightly
</span></span><span style="display:flex;"><span>sudo yum install docker-ce docker-ce-cli containerd.io
</span></span></code></pre></div><h3 id="二进制安装-docker">二进制安装 docker</h3>
<h4 id="下载二进制-docker-包-然后解压">下载二进制 docker 包, 然后解压</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz
</span></span><span style="display:flex;"><span>tar zxvf docker-19.03.9.tgz
</span></span><span style="display:flex;"><span>mv docker/* /usr/bin
</span></span></code></pre></div><h4 id="systemd管理docker">systemd管理docker</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /usr/lib/systemd/system/docker.service <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Description=Docker Application Container Engine
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Documentation=https://docs.docker.com
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">After=network-online.target firewalld.service
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ExecStart=/usr/bin/dockerd
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ExecReload=/bin/kill -s HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">LimitNOFILE=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">LimitNPROC=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">LimitCORE=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">TimeoutStartSec=0
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Delegate=yes
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">KillMode=process
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">StartLimitBurst=3
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">StartLimitInterval=60s
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="创建配置文件">创建配置文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir /etc/docker
</span></span><span style="display:flex;"><span>cat &gt; /etc/docker/daemon.json <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">{
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  &#34;registry-mirrors&#34;: [&#34;https://kvtfrwwp.mirror.aliyuncs.com&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">}
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><p><strong>注：registry-mirrors 阿里云镜像加速器,根据自己的需要换成自己的</strong></p>
<h4 id="启动docker并设置开机启动">启动docker并设置开机启动</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl start docker
</span></span><span style="display:flex;"><span>systemctl <span style="color:#89dceb">enable</span> docker
</span></span></code></pre></div><h2 id="部署master-node">部署Master Node</h2>
<h3 id="生成kube-apiserver证书">生成kube-apiserver证书</h3>
<h4 id="进入到相应工作目录">进入到相应工作目录</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#89dceb">cd</span> ~/TLS/k8s <span style="color:#6c7086;font-style:italic">#此目录上面已经创建了</span>
</span></span></code></pre></div><h4 id="自签证书颁发机构ca">自签证书颁发机构（CA）</h4>
<ul>
<li>ca-config.json</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; ca-config.json <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">{
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  &#34;signing&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;default&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;expiry&#34;: &#34;87600h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    },
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;profiles&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;kubernetes&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">         &#34;expiry&#34;: &#34;87600h&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">         &#34;usages&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;signing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;key encipherment&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;server auth&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;client auth&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">}
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><ul>
<li>ca-csr.json</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; ca-csr.json <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">{
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    },
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;ST&#34;: &#34;Beijing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">}
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="生成证书-2">生成证书</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ls *pem
</span></span><span style="display:flex;"><span>ca-key.pem  ca.pem
</span></span></code></pre></div><h4 id="使用自签ca签发kube-apiserver-https证书">使用自签CA签发kube-apiserver HTTPS证书</h4>
<ol>
<li>
<p>创建证书申请文件</p>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; server-csr.json <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">{
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;10.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;127.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;172.26.3.200&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;172.26.3.201&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;172.26.3.202&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;172.26.3.203&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;172.26.3.204&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;172.26.3.205&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;kubernetes.default&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;kubernetes.default.svc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;kubernetes.default.svc.cluster&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;kubernetes.default.svc.cluster.local&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    },
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">            &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">        }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">}
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><p><!-- raw HTML omitted -->注：上述文件hosts字段中IP为所有Master/LB/VIP IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP<!-- raw HTML omitted --></p>
</li>
<li>
<p>生成证书</p>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#89dceb;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#89dceb;font-weight:bold">=</span>ca-key.pem -config<span style="color:#89dceb;font-weight:bold">=</span>ca-config.json -profile<span style="color:#89dceb;font-weight:bold">=</span>kubernetes server-csr.json | cfssljson -bare server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ls server*pem
</span></span><span style="display:flex;"><span>server-key.pem  server.pem
</span></span></code></pre></div></li>
</ol>
<h3 id="下载二进制包">下载二进制包</h3>
<p>下载页面：https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.19.md#v1199
有很多包，找对应平台的 server包即可</p>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://dl.k8s.io/v1.19.9/kubernetes-server-linux-amd64.tar.gz
</span></span></code></pre></div><h3 id="解压二进制包">解压二进制包</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p /opt/kubernetes/<span style="color:#89dceb;font-weight:bold">{</span>bin,cfg,ssl,logs<span style="color:#89dceb;font-weight:bold">}</span> 
</span></span><span style="display:flex;"><span>tar zxvf kubernetes-server-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#89dceb">cd</span> kubernetes/server/bin
</span></span><span style="display:flex;"><span>cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin
</span></span><span style="display:flex;"><span>cp kubectl /usr/bin/
</span></span></code></pre></div><h3 id="部署kube-apiserver">部署kube-apiserver</h3>
<h4 id="创建配置文件-1">创建配置文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">KUBE_APISERVER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--etcd-servers=https://172.26.3.200:2379,https://172.26.3.201:2379,https://172.26.3.202:2379 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--bind-address=172.26.3.200 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--secure-port=6443 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--advertise-address=172.26.3.200 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--allow-privileged=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--service-cluster-ip-range=10.0.0.0/24 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--authorization-mode=RBAC,Node \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--enable-bootstrap-token-auth=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--token-auth-file=/opt/kubernetes/cfg/token.csv \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--service-node-port-range=30000-32767 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--etcd-cafile=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--etcd-certfile=/opt/etcd/ssl/server.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--audit-log-maxage=30 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--audit-log-maxbackup=3 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--audit-log-maxsize=100 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><p>注：</p>
<ul>
<li>–logtostderr：启用日志</li>
<li>—v：日志等级</li>
<li>–log-dir：日志目录</li>
<li>–etcd-servers：etcd集群地址</li>
<li>–bind-address：监听地址</li>
<li>–secure-port：https安全端口</li>
<li>–advertise-address：集群通告地址</li>
<li>–allow-privileged：启用授权</li>
<li>–service-cluster-ip-range：Service虚拟IP地址段</li>
<li>–enable-admission-plugins：准入控制模块</li>
<li>–authorization-mode：认证授权，启用RBAC授权和节点自管理</li>
<li>–enable-bootstrap-token-auth：启用TLS bootstrap机制</li>
<li>–token-auth-file：bootstrap token文件</li>
<li>–service-node-port-range：Service nodeport类型默认分配端口范围</li>
<li>–kubelet-client-xxx：apiserver访问kubelet客户端证书</li>
<li>–tls-xxx-file：apiserver https证书</li>
<li>–etcd-xxxfile：连接Etcd集群证书</li>
<li>–audit-log-xxx：审计日志</li>
</ul>
<ol start="2">
<li>拷贝刚才生成的证书</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/
</span></span></code></pre></div><h4 id="启用-tls-bootstrapping-机制">启用 TLS Bootstrapping 机制</h4>
<p>TLS Bootstraping：Master apiserver启用TLS认证后，Node节点kubelet和kube-proxy要与kube-apiserver进行通信，必须使用CA签发的有效证书才可以，当Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，Kubernetes引入了TLS bootstraping机制来自动颁发客户端证书，kubelet会以一个低权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。所以强烈建议在Node上使用这种方式，目前主要用于kubelet，kube-proxy还是由我们统一颁发一个证书
a. 创建上述配置文件中token文件
<code>shell cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; EOF 3250cbe3576f5ab28ff4a46d9ecd129b,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot; EOF </code>
格式：token，用户名，UID，用户组
token也可自行生成替换
<code>shell head -c 16 /dev/urandom | od -An -t x | tr -d ' ' </code></p>
<h4 id="systemd管理apiserver">systemd管理apiserver</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /usr/lib/systemd/system/kube-apiserver.service <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Description=Kubernetes API Server
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="启动并设置开机启动-1">启动并设置开机启动</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl start kube-apiserver
</span></span><span style="display:flex;"><span>systemctl <span style="color:#89dceb">enable</span> kube-apiserver
</span></span></code></pre></div><h4 id="授权kubelet-bootstrap用户允许请求证书">授权kubelet-bootstrap用户允许请求证书</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl create clusterrolebinding kubelet-bootstrap <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>--clusterrole<span style="color:#89dceb;font-weight:bold">=</span>system:node-bootstrapper <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>--user<span style="color:#89dceb;font-weight:bold">=</span>kubelet-bootstrap
</span></span></code></pre></div><h3 id="部署kube-controller-manager">部署kube-controller-manager</h3>
<h4 id="创建配置文件-2">创建配置文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">KUBE_CONTROLLER_MANAGER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--leader-elect=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--master=127.0.0.1:8080 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--bind-address=127.0.0.1 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--allocate-node-cidrs=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--cluster-cidr=10.244.0.0/16 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--service-cluster-ip-range=10.0.0.0/24 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--experimental-cluster-signing-duration=87600h0m0s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><ul>
<li>–master：通过本地非安全本地端口8080连接apiserver。</li>
<li>–leader-elect：当该组件启动多个时，自动选举（HA）</li>
<li>–cluster-signing-cert-file/–cluster-signing-key-file：自动为kubelet颁发证书的CA，与apiserver保持一致</li>
</ul>
<h4 id="systemd管理controller-manager">systemd管理controller-manager</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /usr/lib/systemd/system/kube-controller-manager.service <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Description=Kubernetes Controller Manager
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="启动并设置开机启动-2">启动并设置开机启动</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl start kube-controller-manager
</span></span><span style="display:flex;"><span>systemctl <span style="color:#89dceb">enable</span> kube-controller-manager
</span></span></code></pre></div><h3 id="部署kube-scheduler">部署kube-scheduler</h3>
<h4 id="创建配置文件-3">创建配置文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">KUBE_SCHEDULER_OPTS=&#34;--logtostderr=false \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--v=2 \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--log-dir=/opt/kubernetes/logs \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--leader-elect \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--master=127.0.0.1:8080 \
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--bind-address=127.0.0.1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><ul>
<li>–master：通过本地非安全本地端口8080连接apiserver。</li>
<li>–leader-elect：当该组件启动多个时，自动选举（HA）</li>
</ul>
<h4 id="systemd管理scheduler">systemd管理scheduler</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /usr/lib/systemd/system/kube-scheduler.service <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Description=Kubernetes Scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="启动并设置开机启动-3">启动并设置开机启动</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl start kube-scheduler
</span></span><span style="display:flex;"><span>systemctl <span style="color:#89dceb">enable</span> kube-scheduler
</span></span></code></pre></div><h4 id="查看集群状态">查看集群状态</h4>
<p>如上输出说明Master节点组件运行正常</p>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#89dceb;font-weight:bold">[</span>root@k8s-master ~<span style="color:#89dceb;font-weight:bold">]</span><span style="color:#6c7086;font-style:italic"># kubectl get cs</span>
</span></span><span style="display:flex;"><span>Warning: v1 ComponentStatus is deprecated in v1.19+
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE             ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#89dceb;font-weight:bold">{</span><span style="color:#a6e3a1">&#34;health&#34;</span>:<span style="color:#a6e3a1">&#34;true&#34;</span><span style="color:#89dceb;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#89dceb;font-weight:bold">{</span><span style="color:#a6e3a1">&#34;health&#34;</span>:<span style="color:#a6e3a1">&#34;true&#34;</span><span style="color:#89dceb;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#89dceb;font-weight:bold">{</span><span style="color:#a6e3a1">&#34;health&#34;</span>:<span style="color:#a6e3a1">&#34;true&#34;</span><span style="color:#89dceb;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="部署worker-node">部署Worker Node</h2>
<h3 id="创建工作目录并拷贝二进制文件">创建工作目录并拷贝二进制文件</h3>
<h4 id="在所有worker-node创建工作目录">在所有worker node创建工作目录</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p /opt/kubernetes/<span style="color:#89dceb;font-weight:bold">{</span>bin,cfg,ssl,logs<span style="color:#89dceb;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="从master节点拷贝">从master节点拷贝</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#89dceb">cd</span> kubernetes/server/bin
</span></span><span style="display:flex;"><span>cp kubelet kube-proxy /opt/kubernetes/bin   <span style="color:#6c7086;font-style:italic"># 本地拷贝</span>
</span></span></code></pre></div><h3 id="部署kubelet">部署kubelet</h3>
<h4 id="创建配置文件-4">创建配置文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /opt/kubernetes/cfg/kubelet.conf <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">KUBELET_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--hostname-override=k8s-master \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--network-plugin=cni \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--config=/opt/kubernetes/cfg/kubelet-config.yml \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--cert-dir=/opt/kubernetes/ssl \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><ul>
<li>–hostname-override：显示名称，集群中唯一</li>
<li>–network-plugin：启用CNI</li>
<li>–kubeconfig：空路径，会自动生成，后面用于连接apiserver</li>
<li>–bootstrap-kubeconfig：首次启动向apiserver申请证书</li>
<li>–config：配置参数文件</li>
<li>–cert-dir：kubelet证书生成目录</li>
<li>–pod-infra-container-image：管理Pod网络容器的镜像</li>
</ul>
<h4 id="配置参数文件">配置参数文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /opt/kubernetes/cfg/kubelet-config.yml <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">kind: KubeletConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">apiVersion: kubelet.config.k8s.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">address: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">port: 10250
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">readOnlyPort: 10255
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">cgroupDriver: cgroupfs
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">clusterDNS:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">- 10.0.0.2
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">clusterDomain: cluster.local 
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">failSwapOn: false
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">authentication:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  anonymous:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  webhook:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    cacheTTL: 2m0s
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  x509:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    clientCAFile: /opt/kubernetes/ssl/ca.pem 
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">authorization:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  mode: Webhook
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  webhook:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    cacheAuthorizedTTL: 5m0s
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    cacheUnauthorizedTTL: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">evictionHard:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  imagefs.available: 15%
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  memory.available: 100Mi
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  nodefs.available: 10%
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  nodefs.inodesFree: 5%
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">maxOpenFiles: 1000000
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">maxPods: 110
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="生成bootstrapkubeconfig文件">生成bootstrap.kubeconfig文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f5e0dc">KUBE_APISERVER</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;https://172.26.3.200:6443&#34;</span> <span style="color:#6c7086;font-style:italic"># apiserver IP:PORT</span>
</span></span><span style="display:flex;"><span><span style="color:#f5e0dc">TOKEN</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;3250cbe3576f5ab28ff4a46d9ecd129b&#34;</span> <span style="color:#6c7086;font-style:italic"># 与token.csv里保持一致</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic"># 生成 kubelet bootstrap kubeconfig 配置文件</span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --certificate-authority<span style="color:#89dceb;font-weight:bold">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --embed-certs<span style="color:#89dceb;font-weight:bold">=</span><span style="color:#89dceb">true</span> <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --server<span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">${</span><span style="color:#f5e0dc">KUBE_APISERVER</span><span style="color:#a6e3a1">}</span> <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --kubeconfig<span style="color:#89dceb;font-weight:bold">=</span>bootstrap.kubeconfig
</span></span><span style="display:flex;"><span>kubectl config set-credentials <span style="color:#a6e3a1">&#34;kubelet-bootstrap&#34;</span> <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --token<span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">${</span><span style="color:#f5e0dc">TOKEN</span><span style="color:#a6e3a1">}</span> <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --kubeconfig<span style="color:#89dceb;font-weight:bold">=</span>bootstrap.kubeconfig
</span></span><span style="display:flex;"><span>kubectl config set-context default <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --cluster<span style="color:#89dceb;font-weight:bold">=</span>kubernetes <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --user<span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;kubelet-bootstrap&#34;</span> <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --kubeconfig<span style="color:#89dceb;font-weight:bold">=</span>bootstrap.kubeconfig
</span></span><span style="display:flex;"><span>kubectl config use-context default --kubeconfig<span style="color:#89dceb;font-weight:bold">=</span>bootstrap.kubeconfig
</span></span></code></pre></div><p>拷贝到配置文件路径</p>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cp bootstrap.kubeconfig /opt/kubernetes/cfg
</span></span></code></pre></div><h4 id="systemd管理kubelet">systemd管理kubelet</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /usr/lib/systemd/system/kubelet.service <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Description=Kubernetes Kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">After=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="启动并设置开机启动-4">启动并设置开机启动</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl start kubelet
</span></span><span style="display:flex;"><span>systemctl <span style="color:#89dceb">enable</span> kubelet
</span></span></code></pre></div><h3 id="批准kubelet证书申请并加入集群">批准kubelet证书申请并加入集群</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic"># 查看kubelet证书请求</span>
</span></span><span style="display:flex;"><span>kubectl get csr
</span></span><span style="display:flex;"><span>NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style="display:flex;"><span>node-csr-NsZ_wMt-h0zEQBpFhF9mAZ_Qme0GA-js43LpWNqwzrU   6m3s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic"># 批准申请</span>
</span></span><span style="display:flex;"><span>kubectl certificate approve node-csr-NsZ_wMt-h0zEQBpFhF9mAZ_Qme0GA-js43LpWNqwzrU
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic"># 查看节点</span>
</span></span><span style="display:flex;"><span>kubectl get node
</span></span><span style="display:flex;"><span>NAME         STATUS     ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   NotReady   &lt;none&gt;   7s    v1.18.3
</span></span></code></pre></div><p>注：由于网络插件还没有部署，节点会没有准备就绪 NotReady</p>
<h3 id="部署kube-proxy">部署kube-proxy</h3>
<h4 id="创建配置文件-5">创建配置文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /opt/kubernetes/cfg/kube-proxy.conf <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">KUBE_PROXY_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="配置参数文件-1">配置参数文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">kind: KubeProxyConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">bindAddress: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">metricsBindAddress: 0.0.0.0:10249
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">clientConnection:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">hostnameOverride: k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">clusterCIDR: 10.0.0.0/24
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><h4 id="生成kube-proxykubeconfig文件">生成kube-proxy.kubeconfig文件</h4>
<ol>
<li>切换工作目录</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#89dceb">cd</span> TLS/k8s
</span></span></code></pre></div><ol start="2">
<li>创建证书请求文件</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; kube-proxy-csr.json <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">{
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  &#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  &#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  },
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  ]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">}
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><ol start="3">
<li>生成证书</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#89dceb;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#89dceb;font-weight:bold">=</span>ca-key.pem -config<span style="color:#89dceb;font-weight:bold">=</span>ca-config.json -profile<span style="color:#89dceb;font-weight:bold">=</span>kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ls kube-proxy*pem
</span></span><span style="display:flex;"><span>kube-proxy-key.pem  kube-proxy.pem
</span></span></code></pre></div><ol start="4">
<li>生成kubeconfig文件</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f5e0dc">KUBE_APISERVER</span><span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">&#34;https://172.26.3.200:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --certificate-authority<span style="color:#89dceb;font-weight:bold">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --embed-certs<span style="color:#89dceb;font-weight:bold">=</span><span style="color:#89dceb">true</span> <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --server<span style="color:#89dceb;font-weight:bold">=</span><span style="color:#a6e3a1">${</span><span style="color:#f5e0dc">KUBE_APISERVER</span><span style="color:#a6e3a1">}</span> <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --kubeconfig<span style="color:#89dceb;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>kubectl config set-credentials kube-proxy <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --client-certificate<span style="color:#89dceb;font-weight:bold">=</span>./kube-proxy.pem <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --client-key<span style="color:#89dceb;font-weight:bold">=</span>./kube-proxy-key.pem <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --embed-certs<span style="color:#89dceb;font-weight:bold">=</span><span style="color:#89dceb">true</span> <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --kubeconfig<span style="color:#89dceb;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>kubectl config set-context default <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --cluster<span style="color:#89dceb;font-weight:bold">=</span>kubernetes <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --user<span style="color:#89dceb;font-weight:bold">=</span>kube-proxy <span style="color:#89b4fa">\
</span></span></span><span style="display:flex;"><span><span style="color:#89b4fa"></span>  --kubeconfig<span style="color:#89dceb;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>kubectl config use-context default --kubeconfig<span style="color:#89dceb;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span></code></pre></div><ol start="5">
<li>拷贝到配置文件指定路径</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cp kube-proxy.kubeconfig /opt/kubernetes/cfg/
</span></span></code></pre></div><h4 id="systemd管理kube-proxy">systemd管理kube-proxy</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /usr/lib/systemd/system/kube-proxy.service <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Description=Kubernetes Proxy
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span></code></pre></div><ol start="6">
<li>启动并设置开机启动</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl start kube-proxy
</span></span><span style="display:flex;"><span>systemctl <span style="color:#89dceb">enable</span> kube-proxy
</span></span></code></pre></div><h3 id="部署cni网络">部署CNI网络</h3>
<h4 id="先准备好-cni二进制包">先准备好 CNI二进制包</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz
</span></span></code></pre></div><h4 id="解压二进制包并移动到默认工作目录">解压二进制包并移动到默认工作目录</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir /opt/cni/bin
</span></span><span style="display:flex;"><span>tar zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin
</span></span></code></pre></div><h4 id="部署cni网络-1">部署CNI网络</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>sed -i -r <span style="color:#a6e3a1">&#34;s#quay.io/coreos/flannel:.*-rc2#lizhenliang/flannel:v0.12.0-amd64#g&#34;</span> kube-flannel.yml
</span></span></code></pre></div><p>注：默认镜像地址无法访问，修改为docker hub镜像仓库
部署好网络插件,如下显示正常。</p>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl apply -f kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get pods -n kube-system
</span></span><span style="display:flex;"><span>NAME                    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kube-flannel-ds-f58vw   1/1     Running   <span style="color:#fab387">0</span>          44s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get node
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    &lt;none&gt;   96m   v1.19.9
</span></span></code></pre></div><h3 id="授权apiserver访问kubelet">授权apiserver访问kubelet</h3>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; apiserver-to-kubelet-rbac.yaml <span style="color:#a6e3a1">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  labels:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    kubernetes.io/bootstrapping: rbac-defaults
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  name: system:kube-apiserver-to-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  - apiGroups:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      - &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      - nodes/proxy
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      - nodes/stats
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      - nodes/log
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      - nodes/spec
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      - nodes/metrics
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      - pods/log
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    verbs:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">      - &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">---
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  name: system:kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  namespace: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  name: system:kube-apiserver-to-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">  - apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    kind: User
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">    name: kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#a6e3a1">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl apply -f apiserver-to-kubelet-rbac.yaml
</span></span></code></pre></div><h3 id="新增加worker-node">新增加Worker Node</h3>
<h4 id="拷贝已部署好的node相关文件到新节点">拷贝已部署好的Node相关文件到新节点</h4>
<p>在master节点将Worker Node涉及文件拷贝到新节点 172.26.3.201/202</p>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic"># k8s-node1</span>
</span></span><span style="display:flex;"><span>scp -r /opt/kubernetes root@172.26.3.201:/opt/
</span></span><span style="display:flex;"><span>scp -r /usr/lib/systemd/system/<span style="color:#89dceb;font-weight:bold">{</span>kubelet,kube-proxy<span style="color:#89dceb;font-weight:bold">}</span>.service root@172.26.3.201:/usr/lib/systemd/system
</span></span><span style="display:flex;"><span>scp -r /opt/cni/ root@172.26.3.201:/opt/
</span></span><span style="display:flex;"><span>scp /opt/kubernetes/ssl/ca.pem root@172.26.3.201:/opt/kubernetes/ssl
</span></span><span style="display:flex;"><span><span style="color:#6c7086;font-style:italic"># k8s-node2</span>
</span></span><span style="display:flex;"><span>scp -r /opt/kubernetes root@172.26.3.202:/opt/
</span></span><span style="display:flex;"><span>scp -r /usr/lib/systemd/system/<span style="color:#89dceb;font-weight:bold">{</span>kubelet,kube-proxy<span style="color:#89dceb;font-weight:bold">}</span>.service root@172.26.3.202:/usr/lib/systemd/system
</span></span><span style="display:flex;"><span>scp -r /opt/cni/ root@172.26.3.202:/opt/
</span></span><span style="display:flex;"><span>scp /opt/kubernetes/ssl/ca.pem root@172.26.3.202:/opt/kubernetes/ssl
</span></span></code></pre></div><h4 id="删除kubelet证书和kubeconfig文件">删除kubelet证书和kubeconfig文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rm /opt/kubernetes/cfg/kubelet.kubeconfig 
</span></span><span style="display:flex;"><span>rm -f /opt/kubernetes/ssl/kubelet*
</span></span></code></pre></div><p><!-- raw HTML omitted -->注：这几个文件是证书申请审批后自动生成的，每个Node不同，必须删除重新生成<!-- raw HTML omitted --></p>
<h4 id="修改主机名-1">修改主机名</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vi /opt/kubernetes/cfg/kubelet.conf
</span></span><span style="display:flex;"><span>--hostname-override<span style="color:#89dceb;font-weight:bold">=</span>k8s-node1
</span></span><span style="display:flex;"><span>vi /opt/kubernetes/cfg/kube-proxy-config.yml
</span></span><span style="display:flex;"><span>hostnameOverride: k8s-node1
</span></span></code></pre></div><h4 id="启动并设置开机启动-5">启动并设置开机启动</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl start kubelet
</span></span><span style="display:flex;"><span>systemctl <span style="color:#89dceb">enable</span> kubelet
</span></span><span style="display:flex;"><span>systemctl start kube-proxy
</span></span><span style="display:flex;"><span>systemctl <span style="color:#89dceb">enable</span> kube-proxy
</span></span></code></pre></div><h4 id="在master上批准新node-kubelet证书申请">在Master上批准新Node kubelet证书申请</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get csr
</span></span><span style="display:flex;"><span>NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style="display:flex;"><span>node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro   89s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl certificate approve node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro
</span></span></code></pre></div><h4 id="查看node状态">查看Node状态</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get node
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    &lt;none&gt;   15h   v1.19.9
</span></span><span style="display:flex;"><span>k8s-node1    Ready    &lt;none&gt;   13h   v1.19.9
</span></span><span style="display:flex;"><span>k8s-node2    Ready    &lt;none&gt;   13h   v1.19.9
</span></span></code></pre></div><p><!-- raw HTML omitted -->Node2（172.26.3.202 ）节点同上。记得修改主机名<!-- raw HTML omitted --></p>
<h2 id="部署dashboard和coredns">部署Dashboard和CoreDNS</h2>
<h3 id="部署dashboard">部署Dashboard</h3>
<h4 id="下载-yaml-文件">下载 yaml 文件</h4>
<pre tabindex="0"><code>wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml
</code></pre><h4 id="默认dashboard只能集群内部访问修改service为nodeport类型暴露到外部">默认Dashboard只能集群内部访问，修改Service为NodePort类型，暴露到外部</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vi recommended.yaml
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  namespace: kubernetes-dashboard
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - port: <span style="color:#fab387">443</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#fab387">8443</span>
</span></span><span style="display:flex;"><span>      nodePort: <span style="color:#fab387">30001</span>
</span></span><span style="display:flex;"><span>  type: NodePort
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span></code></pre></div><h4 id="部署-dashboard">部署 dashboard</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl apply -f recommended.yaml
</span></span></code></pre></div><h4 id="查看dashboard信息">查看dashboard信息</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get pods,svc -n kubernetes-dashboard
</span></span><span style="display:flex;"><span>NAME                                             READY   STATUS              RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/dashboard-metrics-scraper-694557449d-z8gfb   1/1     Running             <span style="color:#fab387">0</span>          2m18s
</span></span><span style="display:flex;"><span>pod/kubernetes-dashboard-9774cc786-q2gsx         1/1     Running		     <span style="color:#fab387">0</span>          2m19s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#89dceb;font-weight:bold">(</span>S<span style="color:#89dceb;font-weight:bold">)</span>         AGE
</span></span><span style="display:flex;"><span>service/dashboard-metrics-scraper   ClusterIP   10.0.0.141   &lt;none&gt;        8000/TCP        2m19s
</span></span><span style="display:flex;"><span>service/kubernetes-dashboard        NodePort    10.0.0.239   &lt;none&gt;        443:30001/TCP   2m19s
</span></span></code></pre></div><p>访问地址：https://NodeIP:30001 (chrome 不支持自签证书，需要使用 firefox 访问)</p>
<h4 id="创建service-account并绑定默认cluster-admin管理员集群角色">创建service account并绑定默认cluster-admin管理员集群角色</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl create serviceaccount dashboard-admin -n kube-system
</span></span><span style="display:flex;"><span>kubectl create clusterrolebinding dashboard-admin --clusterrole<span style="color:#89dceb;font-weight:bold">=</span>cluster-admin --serviceaccount<span style="color:#89dceb;font-weight:bold">=</span>kube-system:dashboard-admin
</span></span><span style="display:flex;"><span>kubectl describe secrets -n kube-system <span style="color:#cba6f7">$(</span>kubectl -n kube-system get secret | awk <span style="color:#a6e3a1">&#39;/dashboard-admin/{print $1}&#39;</span><span style="color:#cba6f7">)</span>
</span></span></code></pre></div><p>使用输出的token登录Dashboard</p>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>eyJhbGciOiJSUzI1NiIsImtpZCI6IkNERFlwZnp1QmI5enhzVEozMnMybWZ4OEtMU1FLUWVjd1FJQ0ZlOURQbUUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tOTVqOTQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMjliZmI2ODktY2FkOS00NmI3LWJkZjctZjQ3ZWYzNmZlMmE3Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.JqpIqrvTRcCBdd4pKTqUyaj91Y7jvWm8nX8X5ozdz-kKfyaQzb_MAq029fwLLK2i19hPqK5sGG9_vPsuHqEcP07dwtmqAsSNeFS0wXeFob-d9rwmtR1_6V5ulxgTzAJoG4qja23iehqpCrNJs8sa_ffNSR6huzFTG2ZDcHr1RN1zBfXXzsEmlu3eTlXj1cqg4kG-CRdOHGb7UDfUopLTOoe1_l0IE6J30gdQbaXthkGlw2paNwnLnDH_6i69B1ftvunh_Ev447UZ5mTkR9ZX4-ryZy7PwEMxbMFJaGqCUmp9DYRNesHlXXCbxq47sXoK46MkgTVv8RWd8xA3YOcZEQ
</span></span></code></pre></div><h3 id="部署coredns">部署CoreDNS</h3>
<h4 id="准备-corednsyaml">准备 coredns.yaml</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/coredns.yaml.sed
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/deploy.sh
</span></span><span style="display:flex;"><span>chmod +x deploy.sh
</span></span><span style="display:flex;"><span>./deploy.sh -i 10.96.0.10 &gt; coredns.yaml	<span style="color:#6c7086;font-style:italic">#deploy.sh 需要 jq 工具,如果提示没有请安装`yum -y install jq`</span>
</span></span></code></pre></div><h4 id="部署-coredns">部署 coredns</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl apply -f coredns.yaml# 查看kubectl get pods --namespace kube-system
</span></span><span style="display:flex;"><span>kubectl get svc --namespace kube-system
</span></span></code></pre></div><h4 id="dns解析测试">DNS解析测试</h4>
<div class="highlight"><pre tabindex="0" style="color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl run -it --rm dns-test --image<span style="color:#89dceb;font-weight:bold">=</span>busybox:1.28.4 sh
</span></span></code></pre></div>
        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/posts/Linux/Nexus%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/">Nexus安装配置</a></li>
        
        <li><a href="/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/redis%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/">Redis集群部署</a></li>
        
        <li><a href="/posts/Windows/Windows%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9F%A5%E7%9C%8B%E7%A1%AC%E4%BB%B6%E4%BF%A1%E6%81%AF%E5%91%BD%E4%BB%A4/">Windows服务器查看硬件信息命令</a></li>
        
        <li><a href="/posts/Windows/Windows%E4%B8%8B%E4%BD%BF%E7%94%A8bat%E8%AE%BE%E7%BD%AEhttp%E4%BB%A3%E7%90%86/">Windows下使用bat设置http代理</a></li>
        
        <li><a href="/posts/Linux/Kafka-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">Kafka 常用命令</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/Kubernetes' target="_blank">Kubernetes</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    
    

    
    
    <div id="giscus"></div>
    <script src="https://giscus.app/client.js"
        data-repo="linuxkai/blogComment"
        data-repo-id="R_kgDOLr6pTw"
        data-category="Announcements"
        data-category-id="DIC_kwDOLr6pT84CekrB"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position=""
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
    </script>
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2024 <a rel="nofollow" href="https://blog.linuxkai.com/">Linuxkai 的博客</a> 未经允许，禁止转载.
        
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io">Hugo</a>
         &amp; <a rel="nofollow noreferer noopener" href="https://github.com/flysnow-org/maupassant-hugo">maupassant theme</a>.
    </div>
</footer>




<script type="text/javascript">
    window.MathJax = {
        tex2jax: {
            inlineMath: [['$', '$']],
            processEscapes: true
        }
    };
</script>
<script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XB3WESXB7W"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-XB3WESXB7W', { 'anonymize_ip': false });
}
</script>

<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>


<script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://blog.linuxkai.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder='搜索'>
      <input type="hidden" name="sitesearch" value="https://blog.linuxkai.com/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://blog.linuxkai.com/posts/Linux/Elasticsearch-Api-%E6%93%8D%E4%BD%9C/" title="Elasticsearch Api 操作" target="_blank">Elasticsearch Api 操作</a>
    </li>
    
    <li>
        <a href="https://blog.linuxkai.com/posts/Git/git-submodule-%E6%93%8D%E4%BD%9C/" title="Git submodule操作" target="_blank">Git submodule操作</a>
    </li>
    
    <li>
        <a href="https://blog.linuxkai.com/posts/Git/Git%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E5%9C%B0%E5%9D%80%E5%8F%98%E6%9B%B4%E6%9C%AC%E5%9C%B0%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9/" title="Git远程仓库地址变更本地如何修改" target="_blank">Git远程仓库地址变更本地如何修改</a>
    </li>
    
    <li>
        <a href="https://blog.linuxkai.com/posts/Git/Git-%E4%BB%93%E5%BA%93%E8%BF%81%E7%A7%BB/" title="Git 仓库迁移" target="_blank">Git 仓库迁移</a>
    </li>
    
    <li>
        <a href="https://blog.linuxkai.com/posts/Git/Git-%E4%BF%AE%E6%94%B9%E5%B7%B2%E6%8F%90%E4%BA%A4-commit-%E7%9A%84%E4%BF%A1%E6%81%AF/" title="Git 修改已提交 commit 的信息" target="_blank">Git 修改已提交 commit 的信息</a>
    </li>
    
    <li>
        <a href="https://blog.linuxkai.com/posts/Git/Git-%E6%8A%80%E5%B7%A7/" title="Git技巧" target="_blank">Git技巧</a>
    </li>
    
    <li>
        <a href="https://blog.linuxkai.com/posts/Git/git-%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86/" title="Git设置代理" target="_blank">Git设置代理</a>
    </li>
    
    <li>
        <a href="https://blog.linuxkai.com/posts/Git/git-%E4%BF%AE%E6%94%B9%E5%88%86%E6%94%AF%E5%90%8D%E7%A7%B0/" title="Git修改分支名称" target="_blank">Git修改分支名称</a>
    </li>
    
    <li>
        <a href="https://blog.linuxkai.com/posts/Docker/docker-compose-%E4%BF%AE%E6%94%B9%E5%AE%B9%E5%99%A8%E6%97%B6%E5%8C%BA/" title="docker-compose 修改容器时区" target="_blank">docker-compose 修改容器时区</a>
    </li>
    
    <li>
        <a href="https://blog.linuxkai.com/posts/Linux/df%E5%91%BD%E4%BB%A4hang%E4%BD%8F%E4%B8%80%E7%9B%B4%E4%B8%8D%E5%87%BA%E7%BB%93%E6%9E%9C/" title="df命令hang住，一直不出结果" target="_blank">df命令hang住，一直不出结果</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://blog.linuxkai.com/categories/Docker/">Docker (1)</a></li>
    
    <li><a href="https://blog.linuxkai.com/categories/Git/">Git (7)</a></li>
    
    <li><a href="https://blog.linuxkai.com/categories/Kubernetes/">Kubernetes (3)</a></li>
    
    <li><a href="https://blog.linuxkai.com/categories/Linux/">Linux (23)</a></li>
    
    <li><a href="https://blog.linuxkai.com/categories/Python/">Python (1)</a></li>
    
    <li><a href="https://blog.linuxkai.com/categories/Windows/">Windows (2)</a></li>
    
    <li><a href="https://blog.linuxkai.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 (2)</a></li>
    
    <li><a href="https://blog.linuxkai.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 (7)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://blog.linuxkai.com/tags/acme.sh/">Acme.sh</a>
    
    <a href="https://blog.linuxkai.com/tags/Ambari/">Ambari</a>
    
    <a href="https://blog.linuxkai.com/tags/APISIX/">APISIX</a>
    
    <a href="https://blog.linuxkai.com/tags/Bind/">Bind</a>
    
    <a href="https://blog.linuxkai.com/tags/CORS/">CORS</a>
    
    <a href="https://blog.linuxkai.com/tags/disk/">Disk</a>
    
    <a href="https://blog.linuxkai.com/tags/DNS/">DNS</a>
    
    <a href="https://blog.linuxkai.com/tags/Docker/">Docker</a>
    
    <a href="https://blog.linuxkai.com/tags/Elasticsearch/">Elasticsearch</a>
    
    <a href="https://blog.linuxkai.com/tags/ELK/">ELK</a>
    
    <a href="https://blog.linuxkai.com/tags/Filebeat/">Filebeat</a>
    
    <a href="https://blog.linuxkai.com/tags/Git/">Git</a>
    
    <a href="https://blog.linuxkai.com/tags/hadoop/">Hadoop</a>
    
    <a href="https://blog.linuxkai.com/tags/Kafka/">Kafka</a>
    
    <a href="https://blog.linuxkai.com/tags/Kubernetes/">Kubernetes</a>
    
    <a href="https://blog.linuxkai.com/tags/Linux/">Linux</a>
    
    <a href="https://blog.linuxkai.com/tags/Logstash/">Logstash</a>
    
    <a href="https://blog.linuxkai.com/tags/MongoDB/">MongoDB</a>
    
    <a href="https://blog.linuxkai.com/tags/MySQL/">MySQL</a>
    
    <a href="https://blog.linuxkai.com/tags/Nacos/">Nacos</a>
    
    <a href="https://blog.linuxkai.com/tags/Nexus/">Nexus</a>
    
    <a href="https://blog.linuxkai.com/tags/Nginx/">Nginx</a>
    
    <a href="https://blog.linuxkai.com/tags/Prometheus/">Prometheus</a>
    
    <a href="https://blog.linuxkai.com/tags/Python/">Python</a>
    
    <a href="https://blog.linuxkai.com/tags/Redis/">Redis</a>
    
    <a href="https://blog.linuxkai.com/tags/resize2fs/">Resize2fs</a>
    
    <a href="https://blog.linuxkai.com/tags/S3/">S3</a>
    
    <a href="https://blog.linuxkai.com/tags/SSL/">SSL</a>
    
    <a href="https://blog.linuxkai.com/tags/Supervisor/">Supervisor</a>
    
    <a href="https://blog.linuxkai.com/tags/Windows/">Windows</a>
    
    <a href="https://blog.linuxkai.com/tags/ZK/">ZK</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://github.com/linuxkai" title="Linuxkai的Github">Linuxkai的Github</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://blog.linuxkai.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>